<!-- Version: 2025-09-20-GITHUB-VERCEL RECONNECTED -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickInvoice - Generate Professional Invoices in Seconds</title>
    <meta name="description" content="Create professional PDF invoices instantly. Perfect for freelancers and small businesses.">

    <!-- CDN Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script
        id="jspdf-script"
        src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        onload="window.jsPDFLoaded = true; console.log('‚úÖ jsPDF loaded successfully from primary CDN');"
        onerror="window.jsPDFLoadError = true; console.warn('‚ö†Ô∏è Primary CDN failed, attempting fallback...'); loadJsPDFFallback();"
        crossorigin="anonymous">
    </script>
    <script>
        // Fallback CDN loader for jsPDF
        function loadJsPDFFallback() {
            console.log('üîÑ Loading jsPDF from fallback CDN...');

            // Remove the failed script
            const failedScript = document.getElementById('jspdf-script');
            if (failedScript) {
                failedScript.remove();
            }

            // Create new script element with fallback CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.id = 'jspdf-fallback-script';
            fallbackScript.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
            fallbackScript.crossOrigin = 'anonymous';

            fallbackScript.onload = function() {
                window.jsPDFLoaded = true;
                window.jsPDFLoadError = false;
                console.log('‚úÖ jsPDF loaded successfully from fallback CDN');
            };

            fallbackScript.onerror = function() {
                window.jsPDFLoadError = true;
                console.error('‚ùå Both primary and fallback CDNs failed to load jsPDF');
            };

            document.head.appendChild(fallbackScript);
        }

        // Debug utility function - call window.debugQuickInvoice() in console
        window.debugQuickInvoice = function() {
            console.log('üîç QuickInvoice Debug Information:');
            console.log('üìö jsPDF Library Status:', {
                jsPDFLoaded: !!window.jsPDFLoaded,
                jsPDFLoadError: !!window.jsPDFLoadError,
                windowJspdf: typeof window.jspdf,
                jsPDFClass: typeof window.jspdf?.jsPDF,
                primaryScript: !!document.getElementById('jspdf-script'),
                fallbackScript: !!document.getElementById('jspdf-fallback-script')
            });
            console.log('üíæ LocalStorage Data:', {
                quickinvoiceData: !!localStorage.getItem('quickinvoice_data'),
                premiumStatus: !!localStorage.getItem('quickinvoice_premium'),
                timestamp: localStorage.getItem('quickinvoice_timestamp')
            });
            console.log('üåê Page State:', {
                readyState: document.readyState,
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 50) + '...'
            });

            // Test jsPDF functionality
            try {
                if (window.jspdf?.jsPDF) {
                    const testDoc = new window.jspdf.jsPDF();
                    console.log('‚úÖ jsPDF test successful - can create PDF instances');
                } else {
                    console.log('‚ùå jsPDF test failed - cannot create PDF instances');
                }
            } catch (error) {
                console.log('‚ùå jsPDF test error:', error.message);
            }
        };
    </script>
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Google Analytics Placeholder - Replace with your tracking ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#3B82F6'
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS for accessibility and polish -->
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: 0.5rem 1rem;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* Smooth transitions for better UX */
        * {
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        /* Better touch targets for mobile */
        @media (max-width: 768px) {
            button, input[type="button"], input[type="submit"] {
                min-height: 44px;
                min-width: 44px;
            }

            .touch-target {
                min-height: 44px;
                padding: 12px;
            }
        }

        /* Loading animation */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Smooth form animations */
        .form-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pulse animation for payment success celebration */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Improved error states */
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Focus indicators */
        .focus-ring:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .tooltip:hover::after,
        .tooltip:focus::after {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    <!-- Skip Navigation Links for Accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-brand text-white px-4 py-2 rounded-md z-50 transition-all">
        Skip to main content
    </a>
    <a href="#invoice-form" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-32 bg-brand text-white px-4 py-2 rounded-md z-50 transition-all">
        Skip to invoice form
    </a>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-brand">QuickInvoice</h1>
                <div class="flex items-center gap-4">
                    <button id="premium-unlock" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors" aria-label="Unlock premium features for $5">
                        $5 Unlock Premium
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-white py-8 border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                Generate Professional Invoices in Seconds
            </h2>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Perfect for freelancers and small businesses. Create, preview, and download PDF invoices instantly.
            </p>
        </div>
    </section>

    <!-- Main Application -->
    <main id="main-content" class="max-w-6xl mx-auto px-4 py-8" role="main">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Invoice Form -->
            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">Invoice Details</h3>

                <form id="invoice-form" class="space-y-6" novalidate>
                    <!-- Business Information -->
                    <fieldset class="space-y-4">
                        <legend class="text-lg font-medium text-gray-900 mb-3">Your Business</legend>

                        <div>
                            <label for="business-name" class="block text-sm font-medium text-gray-700 mb-1">
                                Business Name *
                            </label>
                            <input
                                type="text"
                                id="business-name"
                                name="businessName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                required
                                aria-describedby="business-name-error"
                                placeholder="Your Business Name"
                            >
                            <div id="business-name-error" class="text-red-600 text-sm mt-1 hidden" role="alert"></div>
                        </div>

                        <div>
                            <label for="business-logo" class="block text-sm font-medium text-gray-700 mb-1">
                                Logo/Company Info
                            </label>
                            <textarea
                                id="business-logo"
                                name="businessInfo"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                placeholder="Your address, phone, email, website..."
                            ></textarea>
                        </div>
                    </fieldset>

                    <!-- Client Information -->
                    <fieldset class="space-y-4">
                        <legend class="text-lg font-medium text-gray-900 mb-3">Bill To</legend>

                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">
                                Client Name *
                            </label>
                            <input
                                type="text"
                                id="client-name"
                                name="clientName"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                required
                                aria-describedby="client-name-error"
                                placeholder="Client or Company Name"
                            >
                            <div id="client-name-error" class="text-red-600 text-sm mt-1 hidden" role="alert"></div>
                        </div>

                        <div>
                            <label for="client-email" class="block text-sm font-medium text-gray-700 mb-1">
                                Client Email
                            </label>
                            <input
                                type="email"
                                id="client-email"
                                name="clientEmail"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                placeholder="client@example.com"
                            >
                        </div>

                        <div>
                            <label for="client-address" class="block text-sm font-medium text-gray-700 mb-1">
                                Client Address
                            </label>
                            <textarea
                                id="client-address"
                                name="clientAddress"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                placeholder="Client's billing address..."
                            ></textarea>
                        </div>
                    </fieldset>

                    <!-- Invoice Details -->
                    <fieldset class="space-y-4">
                        <legend class="text-lg font-medium text-gray-900 mb-3">Invoice Information</legend>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-1">
                                    Invoice Number *
                                </label>
                                <input
                                    type="text"
                                    id="invoice-number"
                                    name="invoiceNumber"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                    required
                                    aria-describedby="invoice-number-error"
                                    placeholder="INV-001"
                                >
                                <div id="invoice-number-error" class="text-red-600 text-sm mt-1 hidden" role="alert"></div>
                            </div>

                            <div>
                                <button
                                    type="button"
                                    id="generate-invoice-number"
                                    class="mt-6 px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors tooltip touch-target focus-ring"
                                    aria-label="Generate automatic invoice number based on current date"
                                    data-tooltip="Generate invoice number automatically"
                                >
                                    Auto-Generate
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="invoice-date" class="block text-sm font-medium text-gray-700 mb-1">
                                    Invoice Date *
                                </label>
                                <input
                                    type="date"
                                    id="invoice-date"
                                    name="invoiceDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                    required
                                    aria-describedby="invoice-date-error"
                                >
                                <div id="invoice-date-error" class="text-red-600 text-sm mt-1 hidden" role="alert"></div>
                            </div>

                            <div>
                                <label for="due-date" class="block text-sm font-medium text-gray-700 mb-1">
                                    Due Date *
                                </label>
                                <input
                                    type="date"
                                    id="due-date"
                                    name="dueDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                    required
                                    aria-describedby="due-date-error"
                                >
                                <div id="due-date-error" class="text-red-600 text-sm mt-1 hidden" role="alert"></div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Line Items -->
                    <fieldset class="space-y-4">
                        <legend class="text-lg font-medium text-gray-900 mb-3">Line Items</legend>

                        <div class="overflow-x-auto">
                            <table class="w-full border border-gray-300 rounded-lg" id="line-items-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-300">Description</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-300 w-20">Qty</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-300 w-24">Rate</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-300 w-24">Total</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-300 w-16">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="line-items-body">
                                    <tr class="line-item-row">
                                        <td class="px-3 py-2 border-b border-gray-200">
                                            <input
                                                type="text"
                                                name="description"
                                                class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand"
                                                placeholder="Service or product description"
                                                aria-label="Item description"
                                            >
                                        </td>
                                        <td class="px-3 py-2 border-b border-gray-200">
                                            <input
                                                type="number"
                                                name="quantity"
                                                min="0"
                                                step="0.01"
                                                class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand quantity-input"
                                                placeholder="1"
                                                aria-label="Quantity"
                                            >
                                        </td>
                                        <td class="px-3 py-2 border-b border-gray-200">
                                            <input
                                                type="number"
                                                name="rate"
                                                min="0"
                                                step="0.01"
                                                class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand rate-input"
                                                placeholder="0.00"
                                                aria-label="Rate or price per unit"
                                            >
                                        </td>
                                        <td class="px-3 py-2 border-b border-gray-200">
                                            <span class="line-total text-gray-700">$0.00</span>
                                        </td>
                                        <td class="px-3 py-2 border-b border-gray-200">
                                            <button
                                                type="button"
                                                class="remove-line-item text-red-600 hover:text-red-800 text-sm font-medium"
                                                aria-label="Remove this line item"
                                            >
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button
                            type="button"
                            id="add-line-item"
                            class="inline-flex items-center px-4 py-2 text-sm bg-brand hover:bg-blue-700 text-white rounded-md transition-colors touch-target focus-ring tooltip"
                            aria-label="Add new line item to invoice"
                            data-tooltip="Add another item to your invoice"
                        >
                            <span class="mr-2">+</span>
                            Add Line Item
                        </button>
                    </fieldset>

                    <!-- Totals -->
                    <fieldset class="space-y-4">
                        <legend class="text-lg font-medium text-gray-900 mb-3">Totals</legend>

                        <div class="space-y-3 max-w-sm ml-auto">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">Subtotal:</span>
                                <span id="subtotal-display" class="font-medium">$0.00</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <label for="tax-rate" class="text-sm font-medium text-gray-700">Tax Rate (%):</label>
                                <div class="flex items-center">
                                    <input
                                        type="number"
                                        id="tax-rate"
                                        name="taxRate"
                                        min="0"
                                        max="100"
                                        step="0.01"
                                        class="w-20 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand text-right"
                                        placeholder="0"
                                        aria-label="Tax rate percentage"
                                    >
                                    <span class="ml-1 text-sm text-gray-500">%</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">Tax Amount:</span>
                                <span id="tax-amount-display" class="font-medium">$0.00</span>
                            </div>

                            <div class="flex justify-between items-center pt-3 border-t border-gray-300">
                                <span class="text-lg font-bold text-gray-900">Grand Total:</span>
                                <span id="grand-total-display" class="text-lg font-bold text-gray-900">$0.00</span>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Notes -->
                    <fieldset>
                        <legend class="text-lg font-medium text-gray-900 mb-3">Additional Information</legend>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                                Notes / Payment Terms
                            </label>
                            <textarea
                                id="notes"
                                name="notes"
                                rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                placeholder="Payment terms, thank you message, or other notes..."
                            ></textarea>
                        </div>
                    </fieldset>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6">
                        <button
                            type="button"
                            id="download-pdf"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled
                            aria-describedby="download-status"
                        >
                            Download PDF Invoice
                        </button>
                        <button
                            type="button"
                            id="clear-form"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-6 rounded-lg font-medium transition-colors"
                        >
                            Clear Form
                        </button>
                    </div>
                    <div id="download-status" class="text-sm text-gray-600 text-center" role="status" aria-live="polite"></div>

                    <!-- Watermark Control -->
                    <div class="watermark-controls mt-4 p-4 bg-gray-50 rounded-lg border">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="watermark-toggle" class="rounded border-gray-300" disabled>
                            <label for="watermark-toggle" class="text-sm text-gray-600">Watermark enabled (upgrade to remove)</label>
                        </div>
                    </div>
                </form>
            </section>

            <!-- Invoice Preview -->
            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 sticky top-24">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Live Preview</h3>
                    <div class="text-sm text-gray-500">
                        Updates in real-time
                    </div>
                </div>

                <!-- Invoice Preview Container -->
                <div id="invoice-preview" class="relative bg-white border border-gray-300 rounded-lg p-6 min-h-[600px] shadow-sm" style="max-width: 100%; font-family: 'Arial', sans-serif;">
                    <!-- Watermark Overlay -->
                    <div id="watermark-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                        <div class="transform -rotate-45 text-gray-300 text-2xl font-bold opacity-50">
                            Generated by QuickInvoice - Upgrade to remove
                        </div>
                    </div>

                    <!-- Invoice Header -->
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="preview-business-name">Your Business Name</h1>
                            <div class="text-gray-600 whitespace-pre-line" id="preview-business-info">Your business information will appear here</div>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">INVOICE</h2>
                            <div class="text-sm text-gray-600">
                                <div>Invoice #: <span id="preview-invoice-number">INV-001</span></div>
                                <div>Date: <span id="preview-invoice-date">-</span></div>
                                <div>Due: <span id="preview-due-date">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Bill To Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Bill To:</h3>
                        <div class="text-gray-700">
                            <div class="font-medium" id="preview-client-name">Client Name</div>
                            <div id="preview-client-email" class="text-gray-600"></div>
                            <div class="whitespace-pre-line" id="preview-client-address"></div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="mb-8">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Description</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold w-20">Qty</th>
                                    <th class="border border-gray-300 px-4 py-2 text-right font-semibold w-24">Rate</th>
                                    <th class="border border-gray-300 px-4 py-2 text-right font-semibold w-24">Total</th>
                                </tr>
                            </thead>
                            <tbody id="preview-line-items">
                                <tr>
                                    <td class="border border-gray-300 px-4 py-3 text-gray-500" colspan="4">
                                        Add line items to see them here
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals Section -->
                    <div class="flex justify-end">
                        <div class="w-64">
                            <div class="flex justify-between py-2">
                                <span class="font-medium">Subtotal:</span>
                                <span id="preview-subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="font-medium">Tax (<span id="preview-tax-rate">0</span>%):</span>
                                <span id="preview-tax-amount">$0.00</span>
                            </div>
                            <div class="flex justify-between py-3 border-t-2 border-gray-900 font-bold text-lg">
                                <span>Total:</span>
                                <span id="preview-grand-total">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="mt-8 pt-8 border-t border-gray-300">
                        <div class="text-gray-700 whitespace-pre-line" id="preview-notes">
                            Thank you for your business!
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-6xl mx-auto px-4 py-6 text-center text-gray-600">
            <p>&copy; 2024 QuickInvoice. Generate professional invoices in seconds.</p>
        </div>
    </footer>

    <!-- Loading Indicator (Hidden by default) -->
    <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand"></div>
            <span class="text-gray-700">Processing...</span>
        </div>
    </div>

    <!-- Success Message (Hidden by default) -->
    <div id="success-message" class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 hidden" role="alert">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <span id="success-message-text">Operation completed successfully!</span>
            </div>
        </div>
    </div>

    <!-- Invoice Generator JavaScript -->
    <script>
        /**
         * QuickInvoice - Professional Invoice Generator
         *
         * A complete invoice generation application with the following features:
         * - Real-time invoice preview
         * - PDF generation with jsPDF
         * - Premium tier with Stripe integration
         * - Mobile-responsive design
         * - Accessibility compliance (WCAG 2.1 AA)
         * - Analytics tracking
         * - Local storage persistence
         * - Comprehensive error handling
         *
         * @version 1.0.0
         * @author QuickInvoice Team
         * @license MIT
         */
        (function() {
            'use strict';

            // === CONFIGURATION ===
            /**
             * Application configuration constants
             * Modify these values to customize the app behavior
             */
            const CONFIG = {
                // Data persistence
                STORAGE_KEY: 'quickinvoice_data',

                // Performance settings
                DEBOUNCE_DELAY: 300, // ms - Input debounce delay
                ERROR_RETRY_DELAY: 2000, // ms - Error retry delay
                TOAST_DURATION: 4000, // ms - Message display duration

                // Invoice settings
                INVOICE_PREFIX: 'INV', // Default invoice number prefix
                MIN_LINE_ITEMS: 1, // Minimum required line items
                MAX_LINE_ITEMS: 50, // Maximum allowed line items

                // Feature flags
                ANALYTICS_ENABLED: typeof gtag !== 'undefined', // Auto-detect GA
                DEBUG_MODE: false, // Enable debug logging

                // UI/UX settings
                MOBILE_BREAKPOINT: 768, // px - Mobile breakpoint
                ANIMATION_DURATION: 300, // ms - Default animation duration

                // Business settings
                DEFAULT_TAX_RATE: 0, // % - Default tax rate
                CURRENCY: 'USD', // Default currency
                DATE_FORMAT: 'en-US' // Default date format
            };

            // === GLOBAL ERROR HANDLING ===

            /**
             * Global error handler for unhandled exceptions
             */
            window.addEventListener('error', function(event) {
                console.error('Global error caught:', event.error);
                trackAnalyticsEvent('error', 'global_error', event.error?.message || 'Unknown error');
                showMessage('An unexpected error occurred. Please refresh the page if the problem persists.', 'error');
            });

            /**
             * Handle unhandled promise rejections
             */
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                trackAnalyticsEvent('error', 'promise_rejection', event.reason?.message || 'Unknown promise error');
                showMessage('A background process failed. The app should continue working normally.', 'warning');
            });

            // === ANALYTICS INTEGRATION ===

            /**
             * Track analytics events with privacy-friendly approach
             * @param {string} action - The action being tracked
             * @param {string} category - The category of the event
             * @param {string} label - Additional label for the event
             * @param {number} value - Optional numeric value
             */
            function trackAnalyticsEvent(action, category, label, value) {
                if (!CONFIG.ANALYTICS_ENABLED) return;

                try {
                    gtag('event', action, {
                        event_category: category,
                        event_label: label,
                        value: value,
                        // Privacy-friendly: no personal data
                        anonymize_ip: true,
                        custom_parameter: 'quickinvoice_action'
                    });
                } catch (error) {
                    console.warn('Analytics tracking failed:', error);
                }
            }

            // === DOM CACHING FOR PERFORMANCE ===

            /**
             * Cache frequently used DOM elements for better performance
             */
            const DOMCache = {
                _cache: new Map(),

                get(selector) {
                    if (!this._cache.has(selector)) {
                        const element = document.querySelector(selector);
                        if (element) {
                            this._cache.set(selector, element);
                        }
                    }
                    return this._cache.get(selector);
                },

                getAll(selector) {
                    return document.querySelectorAll(selector);
                },

                clear() {
                    this._cache.clear();
                }
            };

            // === UTILITY FUNCTIONS ===

            /**
             * Debounce function to limit function calls and improve performance
             * @param {Function} func - The function to debounce
             * @param {number} wait - The number of milliseconds to delay
             * @returns {Function} The debounced function
             * @example
             * const debouncedSave = debounce(saveFormData, 300);
             * input.addEventListener('input', debouncedSave);
             */
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Format number as currency
             */
            function formatCurrency(amount) {
                const num = parseFloat(amount) || 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            }

            /**
             * Parse currency string to number
             */
            function parseCurrency(str) {
                return parseFloat(str.replace(/[^0-9.-]/g, '')) || 0;
            }

            /**
             * Format date for display
             */
            function formatDate(dateStr) {
                if (!dateStr) return '-';
                try {
                    return new Date(dateStr).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return dateStr;
                }
            }

            /**
             * Generate invoice number
             */
            function generateInvoiceNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');

                // Get counter from localStorage
                const counterKey = `invoice_counter_${year}_${month}_${day}`;
                let counter = parseInt(localStorage.getItem(counterKey) || '0', 10) + 1;

                try {
                    localStorage.setItem(counterKey, counter.toString());
                } catch (e) {
                    console.warn('Could not save invoice counter:', e);
                }

                const counterStr = String(counter).padStart(3, '0');
                return `${CONFIG.INVOICE_PREFIX}-${year}-${month}-${day}-${counterStr}`;
            }

            /**
             * Set today's date as default
             */
            function setDefaultDates() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                const invoiceDate = document.getElementById('invoice-date');
                const dueDate = document.getElementById('due-date');

                if (invoiceDate && !invoiceDate.value) {
                    invoiceDate.value = todayStr;
                }

                if (dueDate && !dueDate.value) {
                    // Set due date to 30 days from today
                    const futureDate = new Date(today);
                    futureDate.setDate(futureDate.getDate() + 30);
                    dueDate.value = futureDate.toISOString().split('T')[0];
                }
            }

            // === VALIDATION FUNCTIONS ===

            /**
             * Validate required fields
             */
            function validateForm() {
                const requiredFields = [
                    { id: 'business-name', name: 'Business name' },
                    { id: 'client-name', name: 'Client name' },
                    { id: 'invoice-number', name: 'Invoice number' },
                    { id: 'invoice-date', name: 'Invoice date' },
                    { id: 'due-date', name: 'Due date' }
                ];

                let isValid = true;

                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    const errorElement = document.getElementById(`${field.id}-error`);

                    if (!element || !errorElement) return;

                    const value = element.value.trim();

                    if (!value) {
                        showFieldError(errorElement, `${field.name} is required`);
                        isValid = false;
                    } else {
                        hideFieldError(errorElement);
                    }
                });

                // Validate date logic
                const invoiceDate = document.getElementById('invoice-date');
                const dueDate = document.getElementById('due-date');

                if (invoiceDate && dueDate && invoiceDate.value && dueDate.value) {
                    const invoiceDateValue = new Date(invoiceDate.value);
                    const dueDateValue = new Date(dueDate.value);

                    if (dueDateValue < invoiceDateValue) {
                        const dueDateError = document.getElementById('due-date-error');
                        if (dueDateError) {
                            showFieldError(dueDateError, 'Due date cannot be before invoice date');
                            isValid = false;
                        }
                    }
                }

                // Validate at least one line item with description
                const lineItems = getLineItemsData();
                if (lineItems.length === 0 || !lineItems.some(item => item.description.trim())) {
                    isValid = false;
                }

                return isValid;
            }

            /**
             * Show field error
             */
            function showFieldError(errorElement, message) {
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');

                    // Add error styling to input
                    const input = errorElement.previousElementSibling;
                    if (input && input.tagName === 'INPUT') {
                        input.classList.add('border-red-500', 'focus:ring-red-500');
                        input.classList.remove('border-gray-300', 'focus:ring-brand');
                    }
                }
            }

            /**
             * Hide field error
             */
            function hideFieldError(errorElement) {
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.classList.add('hidden');

                    // Remove error styling from input
                    const input = errorElement.previousElementSibling;
                    if (input && input.tagName === 'INPUT') {
                        input.classList.remove('border-red-500', 'focus:ring-red-500');
                        input.classList.add('border-gray-300', 'focus:ring-brand');
                    }
                }
            }

            // === LINE ITEMS MANAGEMENT ===

            /**
             * Create new line item row
             */
            function createLineItemRow() {
                const row = document.createElement('tr');
                row.className = 'line-item-row';
                row.innerHTML = `
                    <td class="px-3 py-2 border-b border-gray-200">
                        <input
                            type="text"
                            name="description"
                            class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand"
                            placeholder="Service or product description"
                            aria-label="Item description"
                        >
                    </td>
                    <td class="px-3 py-2 border-b border-gray-200">
                        <input
                            type="number"
                            name="quantity"
                            min="0"
                            step="0.01"
                            class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand quantity-input"
                            placeholder="1"
                            aria-label="Quantity"
                        >
                    </td>
                    <td class="px-3 py-2 border-b border-gray-200">
                        <input
                            type="number"
                            name="rate"
                            min="0"
                            step="0.01"
                            class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-brand rate-input"
                            placeholder="0.00"
                            aria-label="Rate or price per unit"
                        >
                    </td>
                    <td class="px-3 py-2 border-b border-gray-200">
                        <span class="line-total text-gray-700">$0.00</span>
                    </td>
                    <td class="px-3 py-2 border-b border-gray-200">
                        <button
                            type="button"
                            class="remove-line-item text-red-600 hover:text-red-800 text-sm font-medium"
                            aria-label="Remove this line item"
                        >
                            Remove
                        </button>
                    </td>
                `;
                return row;
            }

            /**
             * Add new line item
             */
            function addLineItem() {
                const tbody = document.getElementById('line-items-body');
                if (!tbody) return;

                const currentRows = tbody.querySelectorAll('.line-item-row');
                if (currentRows.length >= CONFIG.MAX_LINE_ITEMS) {
                    showMessage('Maximum number of line items reached', 'warning');
                    trackAnalyticsEvent('line_item_limit_reached', 'form_interaction', 'max_items');
                    return;
                }

                const newRow = createLineItemRow();
                tbody.appendChild(newRow);

                // Focus on description field of new row
                const descInput = newRow.querySelector('input[name="description"]');
                if (descInput) {
                    descInput.focus();
                }

                updateRemoveButtonStates();
                updateCalculations();
                saveFormData();

                // Track analytics
                trackAnalyticsEvent('line_item_added', 'form_interaction', 'user_action', currentRows.length + 1);
            }

            /**
             * Remove line item
             */
            function removeLineItem(button) {
                const row = button.closest('.line-item-row');
                const tbody = document.getElementById('line-items-body');

                if (!row || !tbody) return;

                const currentRows = tbody.querySelectorAll('.line-item-row');
                if (currentRows.length <= CONFIG.MIN_LINE_ITEMS) {
                    showMessage('At least one line item is required', 'warning');
                    return;
                }

                row.remove();
                updateRemoveButtonStates();
                updateCalculations();
                updatePreview();
                saveFormData();
            }

            /**
             * Update remove button states
             */
            function updateRemoveButtonStates() {
                const tbody = document.getElementById('line-items-body');
                if (!tbody) return;

                const rows = tbody.querySelectorAll('.line-item-row');
                const removeButtons = tbody.querySelectorAll('.remove-line-item');

                removeButtons.forEach(button => {
                    button.disabled = rows.length <= CONFIG.MIN_LINE_ITEMS;
                    button.style.opacity = button.disabled ? '0.5' : '1';
                    button.style.cursor = button.disabled ? 'not-allowed' : 'pointer';
                });
            }

            /**
             * Calculate line item total
             */
            function calculateLineTotal(row) {
                const quantityInput = row.querySelector('input[name="quantity"]');
                const rateInput = row.querySelector('input[name="rate"]');
                const totalSpan = row.querySelector('.line-total');

                if (!quantityInput || !rateInput || !totalSpan) return 0;

                const quantity = parseFloat(quantityInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const total = quantity * rate;

                totalSpan.textContent = formatCurrency(total);
                return total;
            }

            /**
             * Get line items data
             */
            function getLineItemsData() {
                const tbody = document.getElementById('line-items-body');
                if (!tbody) return [];

                const rows = tbody.querySelectorAll('.line-item-row');
                const items = [];

                rows.forEach(row => {
                    const description = row.querySelector('input[name="description"]')?.value || '';
                    const quantity = parseFloat(row.querySelector('input[name="quantity"]')?.value) || 0;
                    const rate = parseFloat(row.querySelector('input[name="rate"]')?.value) || 0;
                    const total = quantity * rate;

                    items.push({
                        description: description.trim(),
                        quantity,
                        rate,
                        total
                    });
                });

                return items;
            }

            // === CALCULATIONS ===

            /**
             * Update all calculations
             */
            function updateCalculations() {
                const tbody = document.getElementById('line-items-body');
                if (!tbody) return;

                const rows = tbody.querySelectorAll('.line-item-row');
                let subtotal = 0;

                // Calculate line totals and subtotal
                rows.forEach(row => {
                    subtotal += calculateLineTotal(row);
                });

                // Update subtotal display
                const subtotalDisplay = document.getElementById('subtotal-display');
                if (subtotalDisplay) {
                    subtotalDisplay.textContent = formatCurrency(subtotal);
                }

                // Calculate tax
                const taxRateInput = document.getElementById('tax-rate');
                const taxRate = parseFloat(taxRateInput?.value || 0);
                const taxAmount = (subtotal * taxRate) / 100;

                // Update tax amount display
                const taxAmountDisplay = document.getElementById('tax-amount-display');
                if (taxAmountDisplay) {
                    taxAmountDisplay.textContent = formatCurrency(taxAmount);
                }

                // Calculate grand total
                const grandTotal = subtotal + taxAmount;

                // Update grand total display
                const grandTotalDisplay = document.getElementById('grand-total-display');
                if (grandTotalDisplay) {
                    grandTotalDisplay.textContent = formatCurrency(grandTotal);
                }

                // Update download button state
                updateDownloadButtonState();

                return {
                    subtotal,
                    taxRate,
                    taxAmount,
                    grandTotal
                };
            }

            // === PREVIEW UPDATE ===

            /**
             * Update preview pane
             */
            function updatePreview() {
                // Business information
                updatePreviewField('business-name', 'preview-business-name', 'Your Business Name');
                updatePreviewField('business-logo', 'preview-business-info', 'Your business information will appear here');

                // Client information
                updatePreviewField('client-name', 'preview-client-name', 'Client Name');
                updatePreviewField('client-email', 'preview-client-email', '');
                updatePreviewField('client-address', 'preview-client-address', '');

                // Invoice details
                updatePreviewField('invoice-number', 'preview-invoice-number', 'INV-001');

                const invoiceDate = document.getElementById('invoice-date')?.value;
                const dueDateValue = document.getElementById('due-date')?.value;

                const previewInvoiceDate = document.getElementById('preview-invoice-date');
                const previewDueDate = document.getElementById('preview-due-date');

                if (previewInvoiceDate) {
                    previewInvoiceDate.textContent = formatDate(invoiceDate);
                }
                if (previewDueDate) {
                    previewDueDate.textContent = formatDate(dueDateValue);
                }

                // Line items
                updatePreviewLineItems();

                // Totals
                const calculations = updateCalculations();
                updatePreviewField('tax-rate', 'preview-tax-rate', '0');

                const previewSubtotal = document.getElementById('preview-subtotal');
                const previewTaxAmount = document.getElementById('preview-tax-amount');
                const previewGrandTotal = document.getElementById('preview-grand-total');

                if (previewSubtotal) {
                    previewSubtotal.textContent = formatCurrency(calculations.subtotal);
                }
                if (previewTaxAmount) {
                    previewTaxAmount.textContent = formatCurrency(calculations.taxAmount);
                }
                if (previewGrandTotal) {
                    previewGrandTotal.textContent = formatCurrency(calculations.grandTotal);
                }

                // Notes
                updatePreviewField('notes', 'preview-notes', 'Thank you for your business!');
            }

            /**
             * Update individual preview field
             */
            function updatePreviewField(inputId, previewId, defaultText = '') {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);

                if (!input || !preview) return;

                const value = input.value.trim();
                preview.textContent = value || defaultText;
            }

            /**
             * Update preview line items
             */
            function updatePreviewLineItems() {
                const previewBody = document.getElementById('preview-line-items');
                if (!previewBody) return;

                const lineItems = getLineItemsData();
                previewBody.innerHTML = '';

                if (lineItems.length === 0 || !lineItems.some(item => item.description)) {
                    previewBody.innerHTML = `
                        <tr>
                            <td class="border border-gray-300 px-4 py-3 text-gray-500" colspan="4">
                                Add line items to see them here
                            </td>
                        </tr>
                    `;
                    return;
                }

                lineItems.forEach(item => {
                    if (item.description) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="border border-gray-300 px-4 py-2">${escapeHtml(item.description)}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${item.quantity || 0}</td>
                            <td class="border border-gray-300 px-4 py-2 text-right">${formatCurrency(item.rate)}</td>
                            <td class="border border-gray-300 px-4 py-2 text-right">${formatCurrency(item.total)}</td>
                        `;
                        previewBody.appendChild(row);
                    }
                });
            }

            /**
             * Escape HTML to prevent XSS
             */
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Update watermark display based on premium status
             */
            function updateWatermarkDisplay() {
                updateWatermarkToggleState();
                updatePremiumStatusIndicator();
                updateWatermarkOverlay();
            }

            function updateWatermarkToggleState() {
                const watermarkToggle = document.getElementById('watermark-toggle');
                if (!watermarkToggle) return;

                const isPremium = isPremiumActive();
                const remaining = getPremiumInvoicesLeft();

                if (isPremium) {
                    // Premium active - watermark will be skipped
                    watermarkToggle.checked = false; // Watermark is "off"
                    watermarkToggle.disabled = true;

                    // Update label to show premium status
                    const label = watermarkToggle.nextElementSibling;
                    if (label) {
                        label.textContent = `Watermark disabled (${remaining} premium left)`;
                        label.className = 'text-green-600 font-medium';
                    }
                } else {
                    // No premium - watermark will be added
                    watermarkToggle.checked = true; // Watermark is "on"
                    watermarkToggle.disabled = true; // Keep disabled, controlled by premium status

                    // Update label to show upgrade option
                    const label = watermarkToggle.nextElementSibling;
                    if (label) {
                        label.textContent = 'Watermark enabled (upgrade to remove)';
                        label.className = 'text-gray-600';
                    }
                }
            }

            function updatePremiumStatusIndicator() {
                // Find or create premium status indicator near the watermark toggle
                let statusIndicator = document.getElementById('premium-status-indicator');

                if (!statusIndicator) {
                    // Create indicator if it doesn't exist
                    const watermarkContainer = document.querySelector('.watermark-controls') ||
                                               document.querySelector('label[for="watermark-toggle"]')?.parentElement ||
                                               document.querySelector('#watermark-overlay')?.parentElement;

                    if (watermarkContainer) {
                        statusIndicator = document.createElement('div');
                        statusIndicator.id = 'premium-status-indicator';
                        statusIndicator.className = 'text-sm mt-2 px-3 py-1 rounded-lg';
                        watermarkContainer.appendChild(statusIndicator);
                    }
                }

                if (statusIndicator) {
                    const isPremium = isPremiumActive();
                    const remaining = getPremiumInvoicesLeft();

                    if (isPremium) {
                        statusIndicator.textContent = `‚ú® Premium Active: ${remaining} watermark-free invoices remaining`;
                        statusIndicator.className = 'text-sm mt-2 px-3 py-1 rounded-lg bg-green-100 text-green-700 border border-green-200';
                    } else {
                        statusIndicator.textContent = 'üíß Watermarks enabled - upgrade for professional PDFs';
                        statusIndicator.className = 'text-sm mt-2 px-3 py-1 rounded-lg bg-blue-50 text-blue-600 border border-blue-200';
                    }
                }
            }

            function updateWatermarkOverlay() {
                const watermarkOverlay = document.getElementById('watermark-overlay');
                if (!watermarkOverlay) return;

                const isPremium = isPremiumActive();

                if (isPremium) {
                    watermarkOverlay.style.display = 'none';
                } else {
                    watermarkOverlay.style.display = 'flex';
                }
            }

            // === LOCAL STORAGE ===

            /**
             * Save form data to localStorage
             */
            function saveFormData() {
                try {
                    const formData = {
                        businessName: document.getElementById('business-name')?.value || '',
                        businessInfo: document.getElementById('business-logo')?.value || '',
                        clientName: document.getElementById('client-name')?.value || '',
                        clientEmail: document.getElementById('client-email')?.value || '',
                        clientAddress: document.getElementById('client-address')?.value || '',
                        invoiceNumber: document.getElementById('invoice-number')?.value || '',
                        invoiceDate: document.getElementById('invoice-date')?.value || '',
                        dueDate: document.getElementById('due-date')?.value || '',
                        taxRate: document.getElementById('tax-rate')?.value || '',
                        notes: document.getElementById('notes')?.value || '',
                        lineItems: getLineItemsData(),
                        timestamp: Date.now()
                    };

                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(formData));
                } catch (e) {
                    console.warn('Could not save form data:', e);
                }
            }

            /**
             * Load form data from localStorage
             */
            function loadFormData() {
                try {
                    const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                    if (!saved) return false;

                    const formData = JSON.parse(saved);

                    // Restore basic fields
                    const fieldMappings = {
                        businessName: 'business-name',
                        businessInfo: 'business-logo',
                        clientName: 'client-name',
                        clientEmail: 'client-email',
                        clientAddress: 'client-address',
                        invoiceNumber: 'invoice-number',
                        invoiceDate: 'invoice-date',
                        dueDate: 'due-date',
                        taxRate: 'tax-rate',
                        notes: 'notes'
                    };

                    Object.entries(fieldMappings).forEach(([dataKey, elementId]) => {
                        const element = document.getElementById(elementId);
                        if (element && formData[dataKey] !== undefined) {
                            element.value = formData[dataKey];
                        }
                    });

                    // Restore line items
                    if (formData.lineItems && Array.isArray(formData.lineItems)) {
                        restoreLineItems(formData.lineItems);
                    }

                    return true;
                } catch (e) {
                    console.warn('Could not load form data:', e);
                    return false;
                }
            }

            /**
             * Restore line items from saved data
             */
            function restoreLineItems(lineItems) {
                const tbody = document.getElementById('line-items-body');
                if (!tbody) return;

                // Clear existing items
                tbody.innerHTML = '';

                // Add saved items
                lineItems.forEach((item, index) => {
                    const row = createLineItemRow();

                    const descInput = row.querySelector('input[name="description"]');
                    const qtyInput = row.querySelector('input[name="quantity"]');
                    const rateInput = row.querySelector('input[name="rate"]');

                    if (descInput) descInput.value = item.description || '';
                    if (qtyInput) qtyInput.value = item.quantity || '';
                    if (rateInput) rateInput.value = item.rate || '';

                    tbody.appendChild(row);
                });

                // Ensure at least one line item
                const rows = tbody.querySelectorAll('.line-item-row');
                if (rows.length === 0) {
                    tbody.appendChild(createLineItemRow());
                }
            }

            /**
             * Clear form and localStorage
             */
            function clearForm() {
                const form = document.getElementById('invoice-form');
                if (form) {
                    form.reset();
                }

                // Clear localStorage
                try {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                } catch (e) {
                    console.warn('Could not clear saved data:', e);
                }

                // Reset line items to just one
                const tbody = document.getElementById('line-items-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    tbody.appendChild(createLineItemRow());
                }

                // Reset dates and invoice number
                setDefaultDates();

                const invoiceNumberInput = document.getElementById('invoice-number');
                if (invoiceNumberInput) {
                    invoiceNumberInput.value = generateInvoiceNumber();
                }

                // Clear all error states
                document.querySelectorAll('[id$="-error"]').forEach(errorElement => {
                    hideFieldError(errorElement);
                });

                // Update everything
                updateRemoveButtonStates();
                updateCalculations();
                updatePreview();
                updateWatermarkDisplay();
                updateDownloadButtonState();

                showMessage('Form cleared successfully', 'success');
            }

            // === UI HELPERS ===

            /**
             * Update download button state
             */
            function updateDownloadButtonState() {
                const downloadButton = document.getElementById('download-pdf');
                const downloadStatus = document.getElementById('download-status');

                if (!downloadButton) return;

                const isValid = validateForm();
                downloadButton.disabled = !isValid;

                if (downloadStatus) {
                    downloadStatus.textContent = isValid
                        ? 'Ready to download PDF'
                        : 'Please fill in all required fields';
                }
            }

            /**
             * Show message to user with improved UX
             */
            function showMessage(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
                const successMessage = DOMCache.get('#success-message');
                const messageText = DOMCache.get('#success-message-text');

                if (!successMessage || !messageText) {
                    console.warn('Message elements not found');
                    return;
                }

                // Track message events
                trackAnalyticsEvent('message_shown', 'ui_feedback', `${type}:${message.substring(0, 50)}`);

                messageText.textContent = message;

                // Update styling based on type with animation class
                successMessage.className = 'fixed top-4 right-4 px-4 py-3 rounded z-50 form-fade-in';

                switch (type) {
                    case 'success':
                        successMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                        break;
                    case 'warning':
                        successMessage.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
                        break;
                    case 'error':
                        successMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                        // Add shake animation for errors
                        successMessage.classList.add('error-shake');
                        break;
                    default:
                        successMessage.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
                }

                successMessage.classList.remove('hidden');

                // Announce to screen readers
                successMessage.setAttribute('role', 'alert');
                successMessage.setAttribute('aria-live', 'polite');

                // Auto-hide with configurable duration (unless duration is false for persistent messages)
                if (duration !== false) {
                    setTimeout(() => {
                        if (successMessage) {
                            successMessage.classList.add('hidden');
                            successMessage.classList.remove('error-shake');
                            successMessage.removeAttribute('role');
                            successMessage.removeAttribute('aria-live');
                        }
                    }, duration);
                }

                // Return focus to appropriate element if needed
                if (type === 'error') {
                    // For errors, focus on the first invalid input if available
                    const invalidInput = document.querySelector('.border-red-500, [aria-invalid="true"]');
                    if (invalidInput) {
                        setTimeout(() => invalidInput.focus(), 100);
                    }
                }
            }

            // === EVENT HANDLERS ===

            /**
             * Handle form input changes
             */
            function handleFormInput(event) {
                const target = event.target;

                // Clear error state when user starts typing
                if (target.hasAttribute('required')) {
                    const errorElement = document.getElementById(`${target.id}-error`);
                    if (errorElement && target.value.trim()) {
                        hideFieldError(errorElement);
                    }
                }

                // Special handling for quantity and rate inputs
                if (target.matches('.quantity-input, .rate-input') || target.id === 'tax-rate') {
                    updateCalculations();
                }

                // Update preview and save data
                updatePreview();
                updateWatermarkDisplay();
                debouncedSave();
            }

            /**
             * Handle line item operations
             */
            function handleLineItemOperations(event) {
                const target = event.target;

                if (target.matches('.remove-line-item')) {
                    event.preventDefault();
                    removeLineItem(target);
                }
            }

            // === PDF GENERATION ===

            /**
             * Generate and download PDF invoice
             */
            function downloadPDF() {
                try {
                    // Show loading indicator
                    showLoadingIndicator();

                    // Validate form data
                    if (!validateForm()) {
                        hideLoadingIndicator();
                        showMessage('Please fill in all required fields before downloading', 'error');
                        return;
                    }

                    // Check if jsPDF is available
                    if (typeof window.jspdf?.jsPDF === 'undefined') {
                        hideLoadingIndicator();

                        // Provide specific error message based on loading status
                        if (window.jsPDFLoadError) {
                            showMessage('PDF library failed to load from CDN. Please check your internet connection and try refreshing the page.', 'error', false);
                        } else if (!window.jsPDFLoaded) {
                            showMessage('PDF library is still loading. Please wait a moment and try again.', 'warning');
                        } else {
                            showMessage('PDF library not properly initialized. Please refresh the page and try again.', 'error', false);
                        }

                        console.error('jsPDF not available:', {
                            jsPDFLoadError: !!window.jsPDFLoadError,
                            jsPDFLoaded: !!window.jsPDFLoaded,
                            windowJspdf: typeof window.jspdf,
                            windowJsPDFClass: typeof window.jspdf?.jsPDF
                        });
                        return;
                    }

                    // Create new PDF document (A4 size)
                    const doc = new window.jspdf.jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    let yPosition = margin;

                    // Check premium status for watermark using new counter system
                    const isPremium = isPremiumActive();

                    // Get form data
                    const formData = getFormData();
                    const lineItems = getLineItemsData();
                    const calculations = updateCalculations();

                    // Helper function to add text with line height
                    function addText(text, x, y, options = {}) {
                        const fontSize = options.fontSize || 10;
                        const style = options.style || 'normal';
                        const align = options.align || 'left';

                        doc.setFontSize(fontSize);
                        doc.setFont('helvetica', style);

                        if (align === 'right') {
                            doc.text(text, x, y, { align: 'right' });
                        } else if (align === 'center') {
                            doc.text(text, x, y, { align: 'center' });
                        } else {
                            doc.text(text, x, y);
                        }

                        return y + (fontSize * 0.35); // Return next Y position
                    }

                    // Helper function to add multiline text
                    function addMultilineText(text, x, y, maxWidth, options = {}) {
                        if (!text || text.trim() === '') return y;

                        const fontSize = options.fontSize || 10;
                        doc.setFontSize(fontSize);

                        const lines = doc.splitTextToSize(text, maxWidth);
                        lines.forEach((line, index) => {
                            addText(line, x, y + (index * fontSize * 0.4), options);
                        });

                        return y + (lines.length * fontSize * 0.4);
                    }

                    // Header Section
                    yPosition = addText(formData.businessName || 'Your Business Name', margin, yPosition, {
                        fontSize: 20,
                        style: 'bold'
                    });
                    yPosition += 5;

                    if (formData.businessInfo) {
                        yPosition = addMultilineText(formData.businessInfo, margin, yPosition, pageWidth - 2 * margin, {
                            fontSize: 10
                        });
                    }
                    yPosition += 10;

                    // Invoice Title and Details (Right aligned)
                    const rightX = pageWidth - margin;
                    let rightY = margin;

                    rightY = addText('INVOICE', rightX, rightY, {
                        fontSize: 24,
                        style: 'bold',
                        align: 'right'
                    });
                    rightY += 5;

                    rightY = addText(`Invoice #: ${formData.invoiceNumber}`, rightX, rightY, {
                        fontSize: 10,
                        align: 'right'
                    });
                    rightY = addText(`Date: ${formatDateForPDF(formData.invoiceDate)}`, rightX, rightY, {
                        fontSize: 10,
                        align: 'right'
                    });
                    rightY = addText(`Due: ${formatDateForPDF(formData.dueDate)}`, rightX, rightY, {
                        fontSize: 10,
                        align: 'right'
                    });

                    // Ensure yPosition is below header content
                    yPosition = Math.max(yPosition, rightY + 10);

                    // Bill To Section
                    yPosition = addText('Bill To:', margin, yPosition, {
                        fontSize: 12,
                        style: 'bold'
                    });
                    yPosition += 2;

                    yPosition = addText(formData.clientName || 'Client Name', margin, yPosition, {
                        fontSize: 11,
                        style: 'bold'
                    });

                    if (formData.clientEmail) {
                        yPosition = addText(formData.clientEmail, margin, yPosition, {
                            fontSize: 10
                        });
                    }

                    if (formData.clientAddress) {
                        yPosition = addMultilineText(formData.clientAddress, margin, yPosition, pageWidth - 2 * margin, {
                            fontSize: 10
                        });
                    }
                    yPosition += 15;

                    // Line Items Table
                    const tableStartY = yPosition;
                    const colWidths = {
                        description: 90,
                        quantity: 25,
                        rate: 30,
                        total: 30
                    };

                    let currentX = margin;

                    // Table Header
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPosition, pageWidth - 2 * margin, 8, 'F');

                    yPosition += 6;
                    currentX = margin + 2;

                    addText('Description', currentX, yPosition, { fontSize: 10, style: 'bold' });
                    currentX += colWidths.description;

                    addText('Qty', currentX, yPosition, { fontSize: 10, style: 'bold' });
                    currentX += colWidths.quantity;

                    addText('Rate', currentX, yPosition, { fontSize: 10, style: 'bold' });
                    currentX += colWidths.rate;

                    addText('Total', currentX, yPosition, { fontSize: 10, style: 'bold' });

                    yPosition += 5;

                    // Table Border
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, tableStartY, pageWidth - margin, tableStartY);
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);

                    // Table Rows
                    lineItems.forEach((item, index) => {
                        if (!item.description.trim()) return;

                        yPosition += 6;
                        currentX = margin + 2;

                        // Check if we need a new page
                        if (yPosition > pageHeight - 60) {
                            doc.addPage();
                            yPosition = margin + 10;
                        }

                        const description = item.description.length > 50 ?
                            item.description.substring(0, 47) + '...' :
                            item.description;

                        addText(description, currentX, yPosition, { fontSize: 9 });
                        currentX += colWidths.description;

                        addText(item.quantity.toString(), currentX, yPosition, { fontSize: 9 });
                        currentX += colWidths.quantity;

                        addText(formatCurrency(item.rate), currentX, yPosition, { fontSize: 9 });
                        currentX += colWidths.rate;

                        addText(formatCurrency(item.total), currentX, yPosition, { fontSize: 9 });

                        yPosition += 2;
                        doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    });

                    yPosition += 10;

                    // Totals Section
                    const totalsX = pageWidth - 80;

                    yPosition = addText('Subtotal:', totalsX, yPosition, { fontSize: 10 });
                    addText(formatCurrency(calculations.subtotal), pageWidth - margin, yPosition - 4, {
                        fontSize: 10,
                        align: 'right'
                    });

                    yPosition = addText(`Tax (${calculations.taxRate}%):`, totalsX, yPosition, { fontSize: 10 });
                    addText(formatCurrency(calculations.taxAmount), pageWidth - margin, yPosition - 4, {
                        fontSize: 10,
                        align: 'right'
                    });

                    yPosition += 5;
                    doc.setDrawColor(0, 0, 0);
                    doc.line(totalsX, yPosition, pageWidth - margin, yPosition);
                    yPosition += 5;

                    yPosition = addText('Total:', totalsX, yPosition, { fontSize: 12, style: 'bold' });
                    addText(formatCurrency(calculations.grandTotal), pageWidth - margin, yPosition - 4, {
                        fontSize: 12,
                        style: 'bold',
                        align: 'right'
                    });

                    // Notes Section
                    if (formData.notes && formData.notes.trim()) {
                        yPosition += 15;
                        yPosition = addText('Notes:', margin, yPosition, {
                            fontSize: 11,
                            style: 'bold'
                        });
                        yPosition += 2;

                        yPosition = addMultilineText(formData.notes, margin, yPosition, pageWidth - 2 * margin, {
                            fontSize: 10
                        });
                    }

                    // Add watermark for free tier (addWatermark now handles premium check internally)
                    addWatermark(doc, pageWidth, pageHeight);

                    // Generate filename
                    const filename = generatePDFFilename(formData.invoiceNumber, formData.invoiceDate);

                    // Download the PDF
                    doc.save(filename);

                    hideLoadingIndicator();
                    showMessage('PDF downloaded successfully!', 'success');

                    // Handle premium invoice usage after successful PDF generation
                    handlePremiumPDFGeneration();

                    // Track successful PDF generation
                    trackAnalyticsEvent('pdf_download', 'conversion', isPremium ? 'premium_user' : 'free_user', 1);
                    trackAnalyticsEvent('invoice_created', 'user_goal', formData.invoiceNumber);

                } catch (error) {
                    console.error('PDF generation error:', error);
                    hideLoadingIndicator();
                    showMessage('Error generating PDF. Please try again or use browser print as fallback.', 'error');

                    // Offer print fallback
                    setTimeout(() => {
                        if (confirm('PDF generation failed. Would you like to use browser print instead?')) {
                            window.print();
                        }
                    }, 2000);
                }
            }

            /**
             * Add watermark to PDF for free tier
             */
            function addWatermark(doc, pageWidth, pageHeight) {
                // Check premium status - skip watermark if premium is active
                if (isPremiumActive()) {
                    console.log('‚úÖ Premium active - skipping watermark');
                    return; // Exit early, no watermark added
                }

                // Existing watermark code continues here for non-premium users
                try {
                    // Set watermark styling
                    doc.setTextColor(200, 200, 200);
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');

                    // Calculate center position (jsPDF coordinates)
                    const centerX = pageWidth / 2;
                    const centerY = pageHeight / 2;

                    // Add watermark text with proper centering
                    doc.text('Generated by QuickInvoice - Upgrade to remove', centerX, centerY, {
                        angle: -45,
                        align: 'center'
                    });

                    // Reset text color to black
                    doc.setTextColor(0, 0, 0);

                    console.log('‚ÑπÔ∏è Watermark added - upgrade to remove');
                } catch (error) {
                    console.warn('Watermark error:', error);
                    try {
                        // Fallback: Simple centered text without rotation
                        doc.setTextColor(150, 150, 150);
                        doc.setFontSize(20);
                        doc.text('SAMPLE', pageWidth / 2, pageHeight / 2, { align: 'center' });
                        doc.setTextColor(0, 0, 0);
                    } catch (fallbackError) {
                        console.warn('Watermark fallback failed:', fallbackError);
                    }
                }
            }

            /**
             * Get all form data
             */
            function getFormData() {
                return {
                    businessName: document.getElementById('business-name')?.value?.trim() || '',
                    businessInfo: document.getElementById('business-logo')?.value?.trim() || '',
                    clientName: document.getElementById('client-name')?.value?.trim() || '',
                    clientEmail: document.getElementById('client-email')?.value?.trim() || '',
                    clientAddress: document.getElementById('client-address')?.value?.trim() || '',
                    invoiceNumber: document.getElementById('invoice-number')?.value?.trim() || '',
                    invoiceDate: document.getElementById('invoice-date')?.value || '',
                    dueDate: document.getElementById('due-date')?.value || '',
                    taxRate: parseFloat(document.getElementById('tax-rate')?.value) || 0,
                    notes: document.getElementById('notes')?.value?.trim() || ''
                };
            }

            /**
             * Format date for PDF display
             */
            function formatDateForPDF(dateStr) {
                if (!dateStr) return 'Not specified';
                try {
                    return new Date(dateStr).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    return dateStr;
                }
            }

            /**
             * Generate PDF filename
             */
            function generatePDFFilename(invoiceNumber, invoiceDate) {
                // Sanitize invoice number
                const sanitizedInvoiceNumber = (invoiceNumber || 'invoice')
                    .replace(/[^a-zA-Z0-9-_]/g, '_')
                    .substring(0, 20);

                // Format date
                let dateStr = '';
                if (invoiceDate) {
                    try {
                        const date = new Date(invoiceDate);
                        dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                    } catch (e) {
                        dateStr = new Date().toISOString().split('T')[0];
                    }
                } else {
                    dateStr = new Date().toISOString().split('T')[0];
                }

                return `invoice-${sanitizedInvoiceNumber}-${dateStr}.pdf`;
            }

            /**
             * Show loading indicator
             */
            function showLoadingIndicator() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                }

                // Disable download button
                const downloadBtn = document.getElementById('download-pdf');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'Generating PDF...';
                }
            }

            /**
             * Hide loading indicator
             */
            function hideLoadingIndicator() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.classList.add('hidden');
                }

                // Re-enable download button
                const downloadBtn = document.getElementById('download-pdf');
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'Download PDF Invoice';
                }
            }

            // === STRIPE PAYMENT INTEGRATION ===

            /**
             * STRIPE SETUP INSTRUCTIONS (Personal Account)
             * ============================================
             *
             * 1. Create Personal Stripe Account:
             *    - Go to dashboard.stripe.com
             *    - Sign up with personal email (not business)
             *    - Complete identity verification if required
             *
             * 2. Create Product & Price:
             *    a) Go to Products section (dashboard.stripe.com/products)
             *    b) Click "Add product"
             *    c) Product details:
             *       - Name: "QuickInvoice Premium Unlock"
             *       - Description: "Remove watermarks and generate up to 25 professional invoices"
             *       - Image: Optional (can add logo later)
             *    d) Pricing details:
             *       - Pricing model: "One time"
             *       - Price: $5.00 USD
             *       - Price description: "25 Premium Invoices"
             *    e) Click "Save product"
             *    f) Copy the Price ID (starts with "price_") from the pricing section
             *
             * 3. Get API Keys:
             *    - Go to Developers > API keys (dashboard.stripe.com/apikeys)
             *    - Copy "Publishable key" (starts with pk_test_) - already configured below
             *    - Keep "Secret key" (starts with sk_test_) private - not needed for static sites
             *
             * 4. Update Configuration:
             *    - Replace 'price_REPLACE_WITH_ACTUAL_PRICE_ID' below with your actual price ID
             *    - Verify publishable key matches your account
             *
             * 5. Test Cards (for testing):
             *    - Success: 4242 4242 4242 4242 (any future date, any CVC)
             *    - Decline: 4000 0000 0000 0002
             *    - More test cards: stripe.com/docs/testing#cards
             *
             * 6. Go Live (when ready):
             *    - Complete Stripe account setup (bank details, tax info)
             *    - Switch to live mode in Stripe dashboard
             *    - Replace pk_test_ with pk_live_ key
             *    - Create new product in live mode
             *    - Update price ID to live price ID
             *
             * REVENUE: You receive $4.56 per $5.00 payment (Stripe fee: 2.9% + 30¬¢)
             *
             * ============================================
             * DEPLOYMENT INSTRUCTIONS
             * ======================
             *
             * Prerequisites:
             * - Vercel account connected to GitHub
             * - Stripe price ID configured above
             *
             * Deploy Commands:
             * 1. git add .
             * 2. git commit -m "feat: add $5 premium unlock with 25-invoice tracking"
             * 3. git push origin main
             * 4. Vercel auto-deploys from GitHub (or run: vercel --prod)
             *
             * Verification Steps:
             * 1. Open deployed site in incognito browser
             * 2. Fill out invoice form with test data
             * 3. Click "$5 Unlock Premium (25 invoices)" button
             * 4. Should redirect to Stripe checkout (NOT demo mode)
             * 5. Use test card: 4242 4242 4242 4242
             * 6. Complete checkout ‚Üí should redirect back with success
             * 7. Button should show "‚úì Premium (25 left)"
             * 8. Generate PDF ‚Üí should be watermark-free
             * 9. Button should show "‚úì Premium (24 left)"
             *
             * Troubleshooting:
             * - Demo mode popup = price ID not set or Stripe not configured
             * - Parameter errors = check price ID format (should start with "price_")
             * - Checkout fails = verify publishable key matches your account
             * - Success redirect fails = check success_url in Stripe dashboard
             *
             * ============================================
             * TESTING PROCEDURES
             * ==================
             *
             * Test Scenarios:
             *
             * 1. Free User Experience:
             *    - Generate PDF ‚Üí should have watermark
             *    - Button shows "$5 Unlock Premium (25 invoices)"
             *    - Watermark toggle shows "enabled (upgrade to remove)"
             *
             * 2. Payment Flow:
             *    - Click premium button ‚Üí redirect to Stripe
             *    - Use 4242 4242 4242 4242 ‚Üí success
             *    - Redirect back ‚Üí button shows "‚úì Premium (25 left)"
             *    - Success message appears
             *
             * 3. Premium User Experience:
             *    - Generate PDF ‚Üí no watermark
             *    - Counter decrements: "‚úì Premium (24 left)"
             *    - Watermark toggle shows "disabled (X premium left)"
             *    - Premium status indicator shows remaining count
             *
             * 4. Premium Expiration:
             *    - Generate 25 PDFs ‚Üí counter reaches 0
             *    - Button changes to "$5 Unlock Premium (25 invoices)"
             *    - Next PDF has watermark again
             *    - Clear messaging about premium expiration
             *
             * 5. Edge Cases:
             *    - Payment cancellation ‚Üí no premium activation
             *    - Browser refresh during premium ‚Üí state persists
             *    - Multiple tabs ‚Üí premium status syncs
             *
             * Test Cards:
             * - Success: 4242 4242 4242 4242
             * - Decline: 4000 0000 0000 0002
             * - Authentication: 4000 0025 0000 3155
             * - International: 4000 0000 0000 0077
             *
             * ============================================
             * REVENUE INFORMATION
             * ==================
             *
             * Pricing Structure:
             * - Customer pays: $5.00
             * - Stripe fee: $0.44 (2.9% + $0.30)
             * - You receive: $4.56
             *
             * Monthly Revenue Examples:
             * - 10 purchases = $45.60
             * - 25 purchases = $114.00
             * - 50 purchases = $228.00
             * - 100 purchases = $456.00
             *
             * Annual Revenue Examples:
             * - 500 purchases = $2,280
             * - 1,000 purchases = $4,560
             * - 2,000 purchases = $9,120
             *
             * Business Model:
             * - One-time purchase per 25 invoices
             * - Repeat customers likely (freelancers generate many invoices)
             * - Professional PDF generation justifies $5 price point
             * - No ongoing costs (static hosting)
             *
             * Tax Considerations:
             * - Report Stripe income on tax returns
             * - Stripe provides annual 1099-K forms
             * - Consult tax professional for proper reporting
             */
            const STRIPE_CONFIG = {
                // Replace with your actual Stripe publishable key (starts with pk_test_ for testing or pk_live_ for production)
                publishableKey: 'pk_live_51RIaSeLxi5CbZq59WTrfhcfOEqpB9KGQBRoaP708f2pzMKkBA5QDHtFgXBsMlWSr436JS9OnzWjEqOLpaHJbr9gB005VNFhY1L',
                currency: 'usd',
                productName: 'QuickInvoice Premium',
                // Fixed $5 pricing: Simple premium unlock for watermark removal (25 invoices)
                // Create this price in your Stripe dashboard: Products ‚Üí Add Product ‚Üí "$5 Premium Unlock" ‚Üí One-time payment
                priceId: 'price_1SAfsqLxi5CbZq59fFysWD1P', // Actual price ID from Stripe dashboard
                successUrl: window.location.origin + window.location.pathname + '?payment=success',
                cancelUrl: window.location.origin + window.location.pathname + '?payment=cancel'
            };

            /**
             * Initialize Stripe
             */
            let stripe = null;

            function initializeStripe() {
                try {
                    if (typeof Stripe !== 'undefined') {
                        stripe = Stripe(STRIPE_CONFIG.publishableKey);
                        console.log('Stripe initialized successfully');
                        return true;
                    } else {
                        console.warn('Stripe.js not loaded');
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to initialize Stripe:', error);
                    showMessage('Payment system unavailable. Please refresh the page.', 'error');
                    return false;
                }
            }

            /**
             * Get remaining premium invoices count
             */
            function getPremiumInvoicesLeft() {
                const count = parseInt(localStorage.getItem('premiumInvoicesLeft') || '0');
                return Math.max(0, count); // Ensure non-negative
            }

            /**
             * Check if user has premium status (has remaining premium invoices)
             */
            function isPremiumActive() {
                return getPremiumInvoicesLeft() > 0;
            }

            /**
             * Use one premium invoice (call when PDF is generated)
             */
            function usePremiumInvoice() {
                const current = getPremiumInvoicesLeft();
                if (current > 0) {
                    const newCount = current - 1;
                    localStorage.setItem('premiumInvoicesLeft', newCount.toString());
                    console.log(`Premium invoices remaining: ${newCount}`);

                    // Update UI to reflect new count
                    updatePremiumButtonText();
                    updateWatermarkDisplay();

                    return true; // Premium invoice used
                }
                return false; // No premium invoices left
            }

            /**
             * Activate premium (25 invoices) - call on payment success
             */
            function activatePremium() {
                localStorage.setItem('premiumInvoicesLeft', '25');
                console.log('‚úÖ Premium activated! 25 invoices unlocked');

                // Update UI immediately
                updatePremiumButtonText();
                updateWatermarkDisplay();
                updateDownloadButtonState();

                // Show success message
                showMessage('Premium activated! Next 25 invoices will be watermark-free.', 'success');
            }

            /**
             * Handle premium PDF generation - call after successful PDF creation
             */
            function handlePremiumPDFGeneration() {
                // This should be called after successful PDF generation
                if (isPremiumActive()) {
                    usePremiumInvoice();

                    // If this was the last premium invoice, notify user
                    if (getPremiumInvoicesLeft() === 0) {
                        setTimeout(() => {
                            showMessage('All 25 premium invoices used. Watermarks will return for future invoices.', 'info');
                        }, 2000);
                    }
                }
            }

            /**
             * Check and update premium status (updated to use localStorage counter)
             */
            function checkPremiumStatus() {
                const isPremium = isPremiumActive();
                updatePremiumButtonText();
                updateWatermarkDisplay();
                return isPremium;
            }

            // Debug functions for development/testing
            /**
             * Reset premium status (for development/testing)
             */
            function resetPremiumStatus() {
                localStorage.removeItem('premiumInvoicesLeft');
                updatePremiumButtonText();
                updateWatermarkDisplay();
                console.log('Premium status reset');
            }

            /**
             * Add debug premium invoices (for development/testing)
             */
            function addDebugPremium(count = 25) {
                localStorage.setItem('premiumInvoicesLeft', count.toString());
                updatePremiumButtonText();
                updateWatermarkDisplay();
                console.log(`Debug: Added ${count} premium invoices`);
            }

            /**
             * Update premium unlock button text to show remaining count
             */
            function updatePremiumButtonText() {
                const premiumButton = document.getElementById('premium-unlock');
                if (!premiumButton) return;

                const remaining = getPremiumInvoicesLeft();

                if (remaining > 0) {
                    premiumButton.textContent = `‚úì Premium (${remaining} left)`;
                    premiumButton.className = 'bg-green-600 text-white px-4 py-2 rounded-lg font-medium cursor-default';
                    premiumButton.disabled = true;
                    premiumButton.setAttribute('aria-label', `Premium active with ${remaining} invoices remaining`);
                } else {
                    premiumButton.textContent = '$5 Unlock Premium (25 invoices)';
                    premiumButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors';
                    premiumButton.disabled = false;
                    premiumButton.setAttribute('aria-label', 'Unlock premium features for $5');
                }
            }

            /**
             * Update premium unlock button state (legacy function for compatibility)
             */
            function updatePremiumButton(isPremium) {
                // Redirect to new function that uses localStorage counter
                updatePremiumButtonText();
            }

            /**
             * Set premium button loading state
             */
            function setPremiumButtonLoading(isLoading) {
                const premiumButton = document.getElementById('premium-unlock');
                if (!premiumButton) return;

                if (isLoading) {
                    premiumButton.disabled = true;
                    premiumButton.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    `;
                    premiumButton.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg font-medium cursor-not-allowed';
                } else {
                    premiumButton.disabled = false;
                    // Let updatePremiumButtonText() handle the proper text and styling
                    updatePremiumButtonText();
                }
            }

            /**
             * Handle premium unlock button click
             */
            async function handlePremiumUnlock() {
                try {
                    // Check if already premium
                    if (isPremiumActive()) {
                        showMessage('Premium is already active!', 'info');
                        return;
                    }

                    // Set loading state
                    setPremiumButtonLoading(true);

                    // Track attempt
                    trackAnalyticsEvent('premium_unlock_attempt', 'monetization', 'button_click');

                    // Create checkout session (implemented by Stripe Configuration Agent)
                    await createCheckoutSession();

                } catch (error) {
                    handleStripeError(error);
                }
            }

            /**
             * Create a Stripe checkout session
             * Fixed $5 premium unlock using pre-defined Stripe price
             *
             * SETUP INSTRUCTIONS:
             * 1. Login to your Stripe Dashboard (https://dashboard.stripe.com)
             * 2. Go to Products ‚Üí Add Product
             * 3. Product Name: "QuickInvoice Premium"
             * 4. Description: "Remove watermark and unlock premium features (25 invoices)"
             * 5. Pricing: One-time payment, $5.00 USD
             * 6. Copy the price ID (starts with "price_") and replace STRIPE_CONFIG.priceId above
             *
             * SECURITY NOTE: Using your personal Stripe account is safe for this single-product use case.
             * The price ID is public information and doesn't expose sensitive data.
             */
            async function createCheckoutSession() {
                try {
                    if (!stripe) {
                        throw new Error('Stripe not initialized');
                    }

                    // Fixed $5 premium unlock (25 invoices)
                    console.log('üí∞ Starting $5 Premium Unlock Payment');

                    // Use pre-defined price from Stripe dashboard
                    const result = await stripe.redirectToCheckout({
                        mode: 'payment',
                        lineItems: [{
                            price: STRIPE_CONFIG.priceId, // Pre-created price in Stripe dashboard
                            quantity: 1
                        }],
                        successUrl: STRIPE_CONFIG.successUrl,
                        cancelUrl: STRIPE_CONFIG.cancelUrl
                    });

                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                } catch (error) {
                    console.error('Checkout failed:', error);
                    setPremiumButtonLoading(false);

                    // Provide user-friendly error messages
                    if (error.message.includes('not initialized')) {
                        showMessage('Payment system not ready. Please refresh the page and try again.', 'error');
                    } else if (error.message.includes('network')) {
                        showMessage('Network error. Please check your connection and try again.', 'error');
                    } else if (error.message.includes('price_REPLACE')) {
                        showMessage('Payment not configured. Please set up the Stripe price ID first.', 'error');
                    } else {
                        showMessage('Payment system error. Please try again.', 'error');
                    }

                    // Track error for analytics
                    trackAnalyticsEvent('checkout_error', 'monetization', error.message);
                }
            }


            /**
             * Handle successful payment
             */
            function handlePaymentSuccess() {
                try {
                    console.log('üéâ Payment successful! Activating premium...');

                    // Activate 25 premium invoices using the localStorage counter system
                    activatePremium();

                    // Track analytics
                    trackAnalyticsEvent('payment_success', 'monetization', 'premium_unlock');
                    trackAnalyticsEvent('premium_activated', 'user_segment', '25_invoices');
                    trackAnalyticsEvent('premium_purchase_complete', 'monetization', 'conversion_success', 5);
                    trackAnalyticsEvent('purchase', 'ecommerce', 'premium_upgrade', 5);

                    // Update all UI elements
                    updatePremiumButtonText();
                    updateWatermarkDisplay();
                    updateDownloadButtonState();

                    // Show celebration message
                    showMessage('üéâ Payment successful! Premium activated for 25 invoices. Your next PDFs will be watermark-free!', 'success');

                    // Add visual celebration effect
                    celebratePaymentSuccess();

                    // Clean up URL parameters
                    cleanupUrlParameters();

                } catch (error) {
                    console.error('Error processing payment success:', error);
                    showMessage('Payment received, but there was an error activating premium. Please contact support.', 'error');
                    trackAnalyticsEvent('payment_success_error', 'error', error.message);
                }
            }

            /**
             * Payment celebration effect
             */
            function celebratePaymentSuccess() {
                try {
                    // Add celebration animation to premium button
                    const premiumButton = document.getElementById('premium-unlock');
                    if (premiumButton) {
                        premiumButton.style.animation = 'pulse 0.5s ease-in-out 3';

                        // Reset animation after completion
                        setTimeout(() => {
                            premiumButton.style.animation = '';
                        }, 1500);
                    }

                    // Optional: Confetti effect or other celebration
                    // Can be enhanced with libraries like canvas-confetti in the future

                } catch (error) {
                    console.warn('Celebration effect error:', error);
                    // Non-critical, don't disrupt user experience
                }
            }

            /**
             * Handle payment cancellation
             */
            function handlePaymentCancel() {
                try {
                    console.log('üíî Payment was canceled by user');

                    // Track analytics
                    trackAnalyticsEvent('payment_canceled', 'monetization', 'premium_unlock');

                    // Reset button state in case it was stuck loading
                    setPremiumButtonLoading(false);

                    // Show friendly message
                    showMessage('Payment was canceled. No charges were made to your card.', 'info');

                    // Clean up URL parameters
                    cleanupUrlParameters();

                } catch (error) {
                    console.error('Error processing payment cancellation:', error);
                    // Don't show error to user for cancellation
                }
            }

            /**
             * Handle payment failure
             */
            function handlePaymentFailure(error = null) {
                console.error('Payment failed:', error);
                showMessage('Payment failed. Please try again or contact support if the issue persists.', 'error');
                cleanupUrlParameters();
            }

            /**
             * Enhanced error handling for Stripe flow
             */
            function handleStripeError(error) {
                console.error('Stripe error:', error);
                setPremiumButtonLoading(false);

                // Provide user-friendly error messages
                let userMessage = 'Payment system error. Please try again.';

                if (error.message.includes('price_')) {
                    userMessage = 'Payment configuration error. Please contact support.';
                } else if (error.message.includes('network')) {
                    userMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message.includes('canceled')) {
                    userMessage = 'Payment was canceled. No charges were made.';
                }

                showMessage(userMessage, 'error');
                trackAnalyticsEvent('stripe_error', 'error', error.message);
            }

            /**
             * Process URL parameters for payment flow
             */
            function processUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);

                // Handle payment success
                if (urlParams.get('payment') === 'success') {
                    handlePaymentSuccess();

                    // Clean up URL parameters after processing
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    return;
                }

                // Handle payment cancellation
                if (urlParams.get('payment') === 'cancel') {
                    handlePaymentCancel();

                    // Clean up URL parameters
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    return;
                }

                // Handle legacy success parameter (backward compatibility)
                if (urlParams.get('success') === 'true') {
                    handlePaymentSuccess();
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    return;
                }

                // Handle legacy canceled parameter (backward compatibility)
                if (urlParams.get('canceled') === 'true') {
                    handlePaymentCancel();
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    return;
                }

                // Handle payment error
                if (urlParams.has('error')) {
                    handlePaymentFailure(urlParams.get('error'));
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    return;
                }
            }

            /**
             * Clean up URL parameters after processing
             */
            function cleanupUrlParameters() {
                // Remove payment-related parameters from URL without page reload
                if (window.history && window.history.replaceState) {
                    const url = new URL(window.location);
                    // Remove new payment parameter
                    url.searchParams.delete('payment');
                    // Remove legacy parameters for backwards compatibility
                    url.searchParams.delete('success');
                    url.searchParams.delete('canceled');
                    url.searchParams.delete('error');
                    window.history.replaceState({}, document.title, url.pathname + url.hash);
                }
            }

            /**
             * DEBUG HELPER FUNCTIONS (Development Only)
             * =========================================
             * Open browser console and run these commands for testing:
             */

            // Debug: Check current premium status
            function debugPremiumStatus() {
                console.log('=== PREMIUM STATUS DEBUG ===');
                console.log('Premium active:', isPremiumActive());
                console.log('Invoices left:', getPremiumInvoicesLeft());
                console.log('localStorage value:', localStorage.getItem('premiumInvoicesLeft'));
                console.log('Button text:', document.getElementById('premium-unlock')?.textContent);
            }

            // Debug: Simulate premium activation
            function debugActivatePremium(count = 25) {
                console.log(`Debug: Activating premium with ${count} invoices...`);
                localStorage.setItem('premiumInvoicesLeft', count.toString());
                updatePremiumButtonText();
                updateWatermarkDisplay();
                showMessage(`Debug: ${count} premium invoices activated`, 'success');
            }

            // Debug: Simulate premium usage
            function debugUsePremium() {
                if (isPremiumActive()) {
                    usePremiumInvoice();
                    console.log('Debug: Used 1 premium invoice. Remaining:', getPremiumInvoicesLeft());
                } else {
                    console.log('Debug: No premium invoices to use');
                }
            }

            // Debug: Reset premium status
            function debugResetPremium() {
                localStorage.removeItem('premiumInvoicesLeft');
                updatePremiumButtonText();
                updateWatermarkDisplay();
                console.log('Debug: Premium status reset');
            }

            // Debug: Simulate payment success
            function debugPaymentSuccess() {
                console.log('Debug: Simulating payment success...');
                handlePaymentSuccess();
            }

            /**
             * PRODUCTION NOTES:
             * - Remove debug functions before deploying to production
             * - Or wrap in development environment checks
             * - Keep for local testing and development
             */

            /**
             * CONFIGURATION VALIDATION
             * ========================
             */
            function validateConfiguration() {
                const issues = [];

                // Check Stripe publishable key
                if (!STRIPE_CONFIG.publishableKey || STRIPE_CONFIG.publishableKey === 'pk_test_PLACEHOLDER_KEY') {
                    issues.push('Stripe publishable key not configured');
                }

                // Check price ID
                if (!STRIPE_CONFIG.priceId || STRIPE_CONFIG.priceId === 'price_REPLACE_WITH_ACTUAL_PRICE_ID') {
                    issues.push('Stripe price ID not configured - create product in Stripe dashboard');
                }

                // Check Stripe library loaded
                if (typeof Stripe === 'undefined') {
                    issues.push('Stripe.js library not loaded');
                }

                // Check localStorage support
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (e) {
                    issues.push('localStorage not available');
                }

                if (issues.length > 0) {
                    console.warn('‚ö†Ô∏è Configuration Issues:', issues);
                    return false;
                }

                console.log('‚úÖ Configuration validation passed');
                return true;
            }

            // Run validation on startup
            function runStartupValidation() {
                if (!validateConfiguration()) {
                    showMessage('Setup incomplete. Please check browser console for details.', 'warning');
                }
            }

            /**
             * Validate Stripe configuration (Legacy function - replaced by validateConfiguration)
             */
            function validateStripeConfig() {
                if (STRIPE_CONFIG.publishableKey === 'pk_test_PLACEHOLDER_KEY') {
                    console.warn('‚ö†Ô∏è Using placeholder Stripe key. Replace with your actual publishable key for production.');
                    return false;
                }
                if (STRIPE_CONFIG.priceId === 'price_REPLACE_WITH_ACTUAL_PRICE_ID') {
                    console.warn('‚ö†Ô∏è Using placeholder price ID. Create a $5 product in Stripe dashboard and replace STRIPE_CONFIG.priceId.');
                    return false;
                }
                return true;
            }

            // === INITIALIZATION ===

            /**
             * Initialize the application
             */
            function init() {
                try {
                    // Track app initialization
                    const startTime = performance.now();
                    trackAnalyticsEvent('app_initialized', 'performance', 'page_load');

                    // Set default dates and invoice number
                    setDefaultDates();

                    const invoiceNumberInput = document.getElementById('invoice-number');
                    if (invoiceNumberInput && !invoiceNumberInput.value) {
                        invoiceNumberInput.value = generateInvoiceNumber();
                    }

                    // Initialize Stripe
                    initializeStripe();
                    validateStripeConfig();
                    runStartupValidation();

                    // Process URL parameters for payment flow
                    processUrlParameters();

                    // Check premium status
                    const isPremium = checkPremiumStatus();
                    trackAnalyticsEvent('user_type', 'user_segment', isPremium ? 'premium' : 'free');

                    // Load saved data
                    const dataLoaded = loadFormData();
                    if (dataLoaded) {
                        trackAnalyticsEvent('form_data_restored', 'user_experience', 'returning_user');
                    } else {
                        // If no saved data, ensure we have at least one line item
                        const tbody = document.getElementById('line-items-body');
                        if (tbody && !tbody.querySelector('.line-item-row')) {
                            tbody.appendChild(createLineItemRow());
                        }
                        trackAnalyticsEvent('new_user_session', 'user_experience', 'first_visit');
                    }

                    // Set up event listeners
                    setupEventListeners();

                    // Initial calculations and updates
                    updateRemoveButtonStates();
                    updateCalculations();
                    updatePreview();
                    updateWatermarkDisplay();
                    updateDownloadButtonState();

                    // Detect mobile device for enhanced UX
                    const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        document.body.classList.add('mobile-device');
                        trackAnalyticsEvent('mobile_user', 'device_type', 'mobile_detected');
                    }

                    // Track initialization performance
                    const endTime = performance.now();
                    const initTime = Math.round(endTime - startTime);
                    trackAnalyticsEvent('app_init_time', 'performance', 'initialization_ms', initTime);

                    console.log(`Invoice Generator initialized successfully in ${initTime}ms`);

                } catch (error) {
                    console.error('Initialization error:', error);
                    trackAnalyticsEvent('init_error', 'error', error.message);
                    showMessage('Application failed to initialize properly. Please refresh the page.', 'error');
                }
            }

            /**
             * Set up all event listeners
             */
            function setupEventListeners() {
                // Debounced save function
                window.debouncedSave = debounce(saveFormData, CONFIG.DEBOUNCE_DELAY);

                // Form input events
                const form = document.getElementById('invoice-form');
                if (form) {
                    form.addEventListener('input', handleFormInput);
                    form.addEventListener('change', handleFormInput);
                }

                // Line item table events (using event delegation)
                const lineItemsTable = document.getElementById('line-items-table');
                if (lineItemsTable) {
                    lineItemsTable.addEventListener('click', handleLineItemOperations);
                    lineItemsTable.addEventListener('input', handleFormInput);
                }

                // Add line item button
                const addLineItemBtn = document.getElementById('add-line-item');
                if (addLineItemBtn) {
                    addLineItemBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        addLineItem();
                    });
                }

                // Generate invoice number button
                const generateInvoiceBtn = document.getElementById('generate-invoice-number');
                if (generateInvoiceBtn) {
                    generateInvoiceBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const invoiceNumberInput = document.getElementById('invoice-number');
                        if (invoiceNumberInput) {
                            invoiceNumberInput.value = generateInvoiceNumber();
                            handleFormInput({ target: invoiceNumberInput });
                        }
                    });
                }

                // Clear form button
                const clearFormBtn = document.getElementById('clear-form');
                if (clearFormBtn) {
                    clearFormBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('Are you sure you want to clear all form data? This action cannot be undone.')) {
                            clearForm();
                        }
                    });
                }

                // Download PDF button
                const downloadBtn = document.getElementById('download-pdf');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (validateForm()) {
                            downloadPDF();
                        } else {
                            showMessage('Please fill in all required fields before downloading', 'warning');
                        }
                    });
                }

                // Premium unlock button
                const premiumBtn = document.getElementById('premium-unlock');
                if (premiumBtn) {
                    premiumBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        handlePremiumUnlock();
                    });
                }

                // Prevent form submission
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                    });
                }

                // Auto-save on page unload
                window.addEventListener('beforeunload', () => {
                    saveFormData();
                });

                // Handle keyboard shortcuts with analytics tracking
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + S to save (just triggers auto-save)
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        saveFormData();
                        showMessage('Form data saved', 'success');
                        trackAnalyticsEvent('keyboard_shortcut', 'user_interaction', 'ctrl_s_save');
                    }

                    // Ctrl/Cmd + Enter to add line item
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        addLineItem();
                        trackAnalyticsEvent('keyboard_shortcut', 'user_interaction', 'ctrl_enter_add_item');
                    }

                    // Escape key to close any open modals or focus main form
                    if (e.key === 'Escape') {
                        const successMessage = DOMCache.get('#success-message');
                        if (successMessage && !successMessage.classList.contains('hidden')) {
                            successMessage.classList.add('hidden');
                            trackAnalyticsEvent('keyboard_shortcut', 'user_interaction', 'escape_close');
                        }
                    }

                    // Tab navigation enhancements for accessibility
                    if (e.key === 'Tab') {
                        // Track tab usage for accessibility insights
                        trackAnalyticsEvent('keyboard_navigation', 'accessibility', 'tab_usage');
                    }
                });
            }

            // === GLOBAL DEBUG FUNCTIONS ===
            // Make debug functions available in browser console

            // Expose premium debug functions globally
            window.debugPremiumStatus = debugPremiumStatus;
            window.debugActivatePremium = debugActivatePremium;
            window.debugUsePremium = debugUsePremium;
            window.debugResetPremium = debugResetPremium;
            window.debugPaymentSuccess = debugPaymentSuccess;
            window.validateConfiguration = validateConfiguration;

            // === START APPLICATION ===

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

        })();

        /**
         * INTEGRATION VALIDATION SUITE
         * ============================
         * Comprehensive validation of all premium system components
         */

        function runIntegrationValidation() {
            console.log('üîç Starting Integration Validation...');

            const results = {
                stripe: validateStripeIntegration(),
                localStorage: validateLocalStorageIntegration(),
                watermark: validateWatermarkIntegration(),
                payment: validatePaymentFlowIntegration(),
                ui: validateUIIntegration()
            };

            const allPassed = Object.values(results).every(result => result.success);

            console.log('üìä Integration Validation Results:', results);

            if (allPassed) {
                console.log('‚úÖ All integration tests passed! System ready for deployment.');
                showMessage('‚úÖ Integration validation passed! System ready for Stripe setup.', 'success');
            } else {
                console.error('‚ùå Integration validation failed. Check console for details.');
                showMessage('‚ùå Integration issues found. Check browser console for details.', 'error');
            }

            return allPassed;
        }

        function validateStripeIntegration() {
            try {
                // Check Stripe configuration
                const hasConfig = typeof STRIPE_CONFIG !== 'undefined';
                const hasPrice = STRIPE_CONFIG?.priceId && STRIPE_CONFIG.priceId !== 'price_REPLACE_WITH_ACTUAL_PRICE_ID';
                const hasKey = STRIPE_CONFIG?.publishableKey && STRIPE_CONFIG.publishableKey.startsWith('pk_');

                // Check createCheckoutSession function exists
                const hasCheckoutFunction = typeof createCheckoutSession === 'function';

                // Check Stripe library loading
                const hasStripeLib = typeof Stripe !== 'undefined';

                return {
                    success: hasConfig && hasCheckoutFunction && hasStripeLib,
                    details: {
                        config: hasConfig,
                        priceConfigured: hasPrice,
                        keyConfigured: hasKey,
                        checkoutFunction: hasCheckoutFunction,
                        stripeLibrary: hasStripeLib
                    }
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function validateLocalStorageIntegration() {
            try {
                // Check premium functions exist
                const functions = [
                    'getPremiumInvoicesLeft',
                    'isPremiumActive',
                    'usePremiumInvoice',
                    'activatePremium'
                ];

                const functionsExist = functions.every(fn => typeof window[fn] === 'function');

                // Test localStorage operations
                const initialCount = getPremiumInvoicesLeft();
                localStorage.setItem('premiumInvoicesLeft', '5');
                const testCount = getPremiumInvoicesLeft();
                const testActive = isPremiumActive();
                localStorage.setItem('premiumInvoicesLeft', initialCount.toString());

                return {
                    success: functionsExist && testCount === 5 && testActive === true,
                    details: {
                        functionsExist,
                        localStorageWorks: testCount === 5,
                        statusCheck: testActive === true
                    }
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function validateWatermarkIntegration() {
            try {
                // Check watermark functions exist
                const hasAddWatermark = typeof addWatermark === 'function';
                const hasUpdateDisplay = typeof updateWatermarkDisplay === 'function';

                // Check watermark respects premium status
                const originalCount = getPremiumInvoicesLeft();

                // Test with premium active
                localStorage.setItem('premiumInvoicesLeft', '5');
                const shouldSkipWatermark = isPremiumActive();

                // Test with no premium
                localStorage.setItem('premiumInvoicesLeft', '0');
                const shouldShowWatermark = !isPremiumActive();

                // Restore original state
                localStorage.setItem('premiumInvoicesLeft', originalCount.toString());

                return {
                    success: hasAddWatermark && hasUpdateDisplay && shouldSkipWatermark && shouldShowWatermark,
                    details: {
                        addWatermarkExists: hasAddWatermark,
                        updateDisplayExists: hasUpdateDisplay,
                        premiumSkipsWatermark: shouldSkipWatermark,
                        freeShowsWatermark: shouldShowWatermark
                    }
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function validatePaymentFlowIntegration() {
            try {
                // Check payment flow functions exist
                const functions = [
                    'handlePaymentSuccess',
                    'handlePaymentCancel',
                    'processUrlParameters',
                    'setPremiumButtonLoading'
                ];

                const functionsExist = functions.every(fn => typeof window[fn] === 'function');

                // Check URL parameter processing
                const hasProcessUrlParams = typeof processUrlParameters === 'function';

                // Check payment success integration
                const hasPaymentSuccess = typeof handlePaymentSuccess === 'function';

                return {
                    success: functionsExist && hasProcessUrlParams && hasPaymentSuccess,
                    details: {
                        allFunctionsExist: functionsExist,
                        urlProcessing: hasProcessUrlParams,
                        paymentSuccess: hasPaymentSuccess
                    }
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function validateUIIntegration() {
            try {
                // Check UI elements exist
                const premiumButton = document.getElementById('premium-unlock');
                const watermarkToggle = document.getElementById('watermark-toggle');

                // Check UI update functions exist
                const hasUpdateButton = typeof updatePremiumButtonText === 'function';
                const hasUpdateWatermark = typeof updateWatermarkDisplay === 'function';

                // Test UI updates
                const originalCount = getPremiumInvoicesLeft();

                // Test premium UI state
                localStorage.setItem('premiumInvoicesLeft', '10');
                updatePremiumButtonText();
                const buttonTextWithPremium = premiumButton?.textContent || '';

                // Test free UI state
                localStorage.setItem('premiumInvoicesLeft', '0');
                updatePremiumButtonText();
                const buttonTextWithoutPremium = premiumButton?.textContent || '';

                // Restore original state
                localStorage.setItem('premiumInvoicesLeft', originalCount.toString());
                updatePremiumButtonText();

                return {
                    success: premiumButton && hasUpdateButton && hasUpdateWatermark,
                    details: {
                        premiumButtonExists: !!premiumButton,
                        watermarkToggleExists: !!watermarkToggle,
                        updateFunctionsExist: hasUpdateButton && hasUpdateWatermark,
                        uiUpdatesWork: buttonTextWithPremium.includes('Premium') && buttonTextWithoutPremium.includes('$5')
                    }
                };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        /**
         * USER FLOW TESTING
         * ==================
         * Test complete user journeys through the premium system
         */

        function testCompleteUserFlow() {
            console.log('üéØ Testing Complete User Flow...');

            try {
                // 1. Start as free user
                localStorage.removeItem('premiumInvoicesLeft');
                updatePremiumButtonText();
                updateWatermarkDisplay();

                console.log('Step 1: Free user state initialized');
                console.log('- Premium active:', isPremiumActive());
                console.log('- Button text:', document.getElementById('premium-unlock')?.textContent);

                // 2. Simulate payment success
                console.log('Step 2: Simulating payment success...');
                handlePaymentSuccess();

                console.log('- Premium active:', isPremiumActive());
                console.log('- Invoices left:', getPremiumInvoicesLeft());
                console.log('- Button text:', document.getElementById('premium-unlock')?.textContent);

                // 3. Simulate PDF generation (use premium invoices)
                console.log('Step 3: Simulating PDF generations...');
                for (let i = 0; i < 3; i++) {
                    usePremiumInvoice();
                    console.log(`- After PDF ${i + 1}: ${getPremiumInvoicesLeft()} invoices left`);
                }

                // 4. Test premium expiration
                console.log('Step 4: Testing premium expiration...');
                localStorage.setItem('premiumInvoicesLeft', '1');
                updatePremiumButtonText();
                usePremiumInvoice(); // Should go to 0

                console.log('- Premium active after expiration:', isPremiumActive());
                console.log('- Button text after expiration:', document.getElementById('premium-unlock')?.textContent);

                console.log('‚úÖ Complete user flow test passed!');
                showMessage('‚úÖ User flow test completed successfully!', 'success');
                return true;

            } catch (error) {
                console.error('‚ùå User flow test failed:', error);
                showMessage('‚ùå User flow test failed. Check console for details.', 'error');
                return false;
            }
        }

        /**
         * DEPLOYMENT READINESS CHECK
         * ==========================
         * Final validation before deployment
         */

        function checkDeploymentReadiness() {
            console.log('üöÄ Checking Deployment Readiness...');

            const checks = [
                {
                    name: 'Stripe Configuration',
                    test: () => typeof STRIPE_CONFIG !== 'undefined' && STRIPE_CONFIG.priceId !== 'price_REPLACE_WITH_ACTUAL_PRICE_ID',
                    message: 'Replace price ID with actual Stripe price'
                },
                {
                    name: 'Publishable Key',
                    test: () => typeof STRIPE_CONFIG !== 'undefined' && (STRIPE_CONFIG.publishableKey.startsWith('pk_test_') || STRIPE_CONFIG.publishableKey.startsWith('pk_live_')),
                    message: 'Valid Stripe publishable key configured'
                },
                {
                    name: 'Premium Functions',
                    test: () => typeof isPremiumActive === 'function' && typeof activatePremium === 'function',
                    message: 'Premium system functions available'
                },
                {
                    name: 'Watermark Integration',
                    test: () => typeof addWatermark === 'function',
                    message: 'Watermark system integrated'
                },
                {
                    name: 'Payment Flow',
                    test: () => typeof handlePaymentSuccess === 'function',
                    message: 'Payment success handling ready'
                },
                {
                    name: 'UI Elements',
                    test: () => !!document.getElementById('premium-unlock'),
                    message: 'Premium button exists in UI'
                },
                {
                    name: 'Stripe Library',
                    test: () => typeof Stripe !== 'undefined',
                    message: 'Stripe.js library loaded'
                },
                {
                    name: 'PDF Library',
                    test: () => typeof jsPDF !== 'undefined',
                    message: 'jsPDF library loaded'
                },
                {
                    name: 'LocalStorage Support',
                    test: () => {
                        try {
                            localStorage.setItem('test', 'test');
                            localStorage.removeItem('test');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    },
                    message: 'LocalStorage available'
                }
            ];

            const results = checks.map(check => ({
                ...check,
                passed: check.test()
            }));

            const allPassed = results.every(result => result.passed);

            console.table(results);

            if (allPassed) {
                console.log('üéâ System ready for deployment!');
                if (typeof showMessage === 'function') {
                    showMessage('üéâ System validation complete! Ready to deploy and configure Stripe.', 'success');
                }
            } else {
                console.warn('‚ö†Ô∏è Deployment readiness issues found');
                const failed = results.filter(r => !r.passed);
                failed.forEach(check => console.warn(`- ${check.name}: ${check.message}`));
                if (typeof showMessage === 'function') {
                    showMessage('‚ö†Ô∏è System issues found. Check console for details.', 'warning');
                }
            }

            return allPassed;
        }

        /**
         * VALIDATION COMMAND CENTER
         * =========================
         * Central hub for running all validation tests
         */

        function runAllValidationTests() {
            console.log('üß™ Running Complete Validation Suite...');
            console.log('='.repeat(50));

            const tests = [
                { name: 'Integration Validation', fn: runIntegrationValidation },
                { name: 'User Flow Testing', fn: testCompleteUserFlow },
                { name: 'Deployment Readiness', fn: checkDeploymentReadiness }
            ];

            const results = [];

            for (const test of tests) {
                console.log(`\nüî¨ Running ${test.name}...`);
                try {
                    const result = test.fn();
                    results.push({ name: test.name, passed: result });
                    console.log(`${result ? '‚úÖ' : '‚ùå'} ${test.name}: ${result ? 'PASSED' : 'FAILED'}`);
                } catch (error) {
                    console.error(`‚ùå ${test.name} failed with error:`, error);
                    results.push({ name: test.name, passed: false, error: error.message });
                }
            }

            console.log('\nüìã VALIDATION SUMMARY');
            console.log('='.repeat(50));
            console.table(results);

            const allPassed = results.every(r => r.passed);

            if (allPassed) {
                console.log('üéâ ALL VALIDATION TESTS PASSED!');
                console.log('‚úÖ System is ready for production deployment');
                showMessage('üéâ All validation tests passed! System ready for production.', 'success');
            } else {
                console.log('‚ùå Some validation tests failed');
                console.log('‚ö†Ô∏è Review issues before deployment');
                showMessage('‚ùå Validation issues found. Review console before deployment.', 'error');
            }

            return allPassed;
        }

        /**
         * QUICK VALIDATION TEST
         * ====================
         * Simple test to verify basic functionality
         */
        function quickValidationTest() {
            console.log('‚ö° Running Quick Validation Test...');

            const issues = [];

            // Test 1: Core functions exist
            const requiredFunctions = [
                'isPremiumActive', 'activatePremium', 'usePremiumInvoice', 'getPremiumInvoicesLeft',
                'addWatermark', 'updateWatermarkDisplay', 'handlePaymentSuccess', 'createCheckoutSession',
                'updatePremiumButtonText', 'processUrlParameters', 'setPremiumButtonLoading', 'handlePaymentCancel'
            ];

            requiredFunctions.forEach(fn => {
                if (typeof window[fn] !== 'function') {
                    issues.push(`Missing function: ${fn}`);
                }
            });

            // Test 2: DOM elements exist
            const requiredElements = ['premium-unlock', 'watermark-toggle'];
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    issues.push(`Missing DOM element: ${id}`);
                }
            });

            // Test 3: Libraries loaded
            if (typeof Stripe === 'undefined') issues.push('Stripe library not loaded');
            if (typeof jsPDF === 'undefined') issues.push('jsPDF library not loaded');

            // Test 4: Configuration exists
            if (typeof STRIPE_CONFIG === 'undefined') issues.push('STRIPE_CONFIG not defined');

            // Test 5: localStorage works
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                issues.push('localStorage not available');
            }

            if (issues.length === 0) {
                console.log('‚úÖ Quick validation passed! All components ready.');
                showMessage('‚úÖ Quick validation passed! System ready for testing.', 'success');
                return true;
            } else {
                console.warn('‚ö†Ô∏è Quick validation issues:', issues);
                showMessage(`‚ö†Ô∏è ${issues.length} validation issues found`, 'warning');
                return false;
            }
        }

        // Expose validation functions globally for console access
        window.runIntegrationValidation = runIntegrationValidation;
        window.testCompleteUserFlow = testCompleteUserFlow;
        window.checkDeploymentReadiness = checkDeploymentReadiness;
        window.runAllValidationTests = runAllValidationTests;
        window.quickValidationTest = quickValidationTest;

        // Auto-run deployment readiness check after page load
        if (typeof window !== 'undefined') {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    console.log('\nüîß Auto-running deployment readiness check...');
                    checkDeploymentReadiness();

                    // Display validation guide
                    console.log('\nüìã VALIDATION COMMANDS AVAILABLE:');
                    console.log('==========================================');
                    console.log('‚Ä¢ quickValidationTest()     - Quick 30-second test');
                    console.log('‚Ä¢ runIntegrationValidation() - Component integration test');
                    console.log('‚Ä¢ testCompleteUserFlow()    - End-to-end user flow test');
                    console.log('‚Ä¢ checkDeploymentReadiness() - Production readiness check');
                    console.log('‚Ä¢ runAllValidationTests()   - Complete validation suite');
                    console.log('');
                    console.log('üìñ See VALIDATION_GUIDE.md for detailed instructions');
                    console.log('üí° Run runAllValidationTests() for complete validation');
                }, 2000);
            });
        }

        /**
         * DEPLOYMENT CHECKLIST:
         *
         * 1. Analytics Setup:
         *    - Replace 'GA_MEASUREMENT_ID' with your actual Google Analytics ID
         *    - Test analytics events in GA debug mode
         *
         * 2. Stripe Integration:
         *    - Replace 'pk_test_PLACEHOLDER_KEY' with your actual Stripe publishable key
         *    - Set up webhook endpoints for production payment handling
         *    - Update success/cancel URLs for your domain
         *
         * 3. Performance:
         *    - Enable gzip compression on your server
         *    - Set up CDN for faster global delivery
         *    - Monitor Core Web Vitals in production
         *
         * 4. Security:
         *    - Enable HTTPS
         *    - Set appropriate CSP headers
         *    - Test with various browsers and screen readers
         *
         * 5. Customization:
         *    - Update CONFIG object with your business settings
         *    - Modify colors in Tailwind config or CSS
         *    - Add your business branding/logo
         *
         * 6. Testing:
         *    - Test invoice generation with various data
         *    - Verify mobile responsiveness
         *    - Test accessibility with screen readers
         *    - Validate PDF output across devices
         */
    </script>
</body>
</html>